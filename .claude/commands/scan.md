# /scan - セキュリティと品質の包括的検証

**目的**: プロジェクトのセキュリティ脆弱性と品質問題を検出し、検証する

## 概要

`/scan`コマンドは、コードベース全体をスキャンし、セキュリティリスクと品質問題を特定します。既存のツール（bandit、pip-audit）と連携して包括的な検証を提供します。

## 使用方法

```bash
/scan [オプション] [対象]
```

## オプション

### --security
セキュリティ脆弱性のスキャン：
- SQLインジェクション
- XSS（クロスサイトスクリプティング）
- 安全でない乱数生成
- ハードコードされた認証情報
- 不適切な暗号化

### --validate
品質検証の実行：
- コーディング規約の遵守
- 型の一貫性
- テストカバレッジ
- ドキュメントの完全性
- 依存関係の健全性

### --owasp
OWASP Top 10に基づく検証：
- A01: アクセス制御の不備
- A02: 暗号化の失敗
- A03: インジェクション
- A04: 安全でない設計
- A05: セキュリティの設定ミス
- A06: 脆弱で古いコンポーネント
- A07: 識別と認証の失敗
- A08: ソフトウェアとデータの整合性の失敗
- A09: セキュリティログとモニタリングの失敗
- A10: サーバーサイドリクエストフォージェリ

### --fix
検出された問題の自動修正：
- 安全な代替案への置換
- セキュリティパッチの適用
- 設定の強化
- 依存関係の更新

## スキャン項目

### セキュリティチェック

```yaml
認証・認可:
  - パスワードの複雑性
  - セッション管理
  - 権限チェック
  - 多要素認証

データ保護:
  - 暗号化の実装
  - 機密データの処理
  - PII（個人識別情報）の扱い
  - データマスキング

入力検証:
  - サニタイゼーション
  - バリデーション
  - エスケープ処理
  - 型チェック
```

### 品質チェック

```yaml
コード品質:
  - 循環的複雑度
  - 重複コード
  - デッドコード
  - 未使用の変数/関数

保守性:
  - モジュール結合度
  - 依存関係の健全性
  - ドキュメントカバレッジ
  - テストカバレッジ

パフォーマンス:
  - N+1クエリ
  - 非効率なアルゴリズム
  - メモリリーク
  - リソースの適切な解放
```

## 実行例

### 基本的な使用
```bash
# セキュリティスキャン
/scan --security

# OWASP Top 10チェック
/scan --owasp

# 品質検証
/scan --validate

# 包括的スキャン
/scan --security --owasp --validate
```

### 自動修正付き
```bash
# セキュリティ問題の自動修正
/scan --security --fix

# 修正前の確認
/scan --security --fix --dry-run
```

## 出力形式

```yaml
スキャン結果サマリー:
  スキャン対象: [ファイル数]
  実行時間: [秒]

発見された問題:
  セキュリティ:
    CRITICAL: [件数]
    HIGH: [件数]
    MEDIUM: [件数]
    LOW: [件数]

  品質:
    エラー: [件数]
    警告: [件数]
    情報: [件数]

詳細:
  - ID: SEC-001
    重大度: CRITICAL
    カテゴリ: SQLインジェクション
    場所: src/database/query.py:45
    説明: ユーザー入力が直接SQLクエリに使用されています
    証拠: f"SELECT * FROM users WHERE id = {user_id}"
    推奨修正: パラメータ化クエリを使用

  - ID: QUA-023
    重大度: HIGH
    カテゴリ: 複雑度
    場所: src/auth/validator.py:120
    説明: 関数の循環的複雑度が15を超えています（測定値: 18）
    推奨修正: 関数を小さな単位に分割

コンプライアンス:
  OWASP Top 10: 8/10 合格
  PCI DSS: 該当項目なし
  GDPR: 要対応事項あり
```

## 既存ツールとの統合

`/scan`は以下のツールと連携：

```bash
# セキュリティツール
make security    # banditを実行
make audit       # pip-auditを実行

# 品質ツール
make lint        # ruffでリント
make typecheck   # mypyで型チェック
make test-cov    # カバレッジ測定

# 統合ワークフロー
/scan --security → make security → make audit → 総合レポート
```

## カスタムルール

プロジェクト固有のルールを`.claude/scan-rules.yml`に定義：

```yaml
custom_rules:
  - id: PROJ-001
    name: API キー検出
    pattern: "api[_-]?key\\s*=\\s*['\"][^'\"]+['\"]"
    severity: CRITICAL
    message: "APIキーがハードコードされています"

  - id: PROJ-002
    name: デバッグコード検出
    pattern: "print\\(|console\\.log\\("
    severity: MEDIUM
    message: "デバッグ用の出力が残っています"
```

## 除外設定

特定のファイルやパターンを除外：

```yaml
# .claude/scan-ignore.yml
ignore:
  files:
    - "tests/**"
    - "*.test.py"

  rules:
    - SEC-001  # 特定のルールを無効化

  patterns:
    - "# nosec"  # コメントによる除外
```

## ベストプラクティス

1. **定期的な実行**: 日次または週次でスキャンを実行
2. **CI/CD統合**: PRごとに自動スキャン
3. **段階的改善**: 重大度の高い問題から対処
4. **False Positive対応**: 誤検出は適切に除外設定
5. **継続的な更新**: ルールとパターンの定期的な見直し

## 注意事項

- スキャンは補完的なツールであり、専門的なセキュリティ監査の代替ではありません
- `--fix`オプションは必ず変更内容を確認してから適用してください
- 大規模なコードベースではスキャンに時間がかかる場合があります
- カスタムルールは慎重にテストしてから本番環境で使用してください
