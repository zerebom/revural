# UI不具合 最終修正計画書 (2025/09/14)

## 1. 概要

現行実装で確認された4つのUI不具合（ハイライト視認性、アコーディオンデザイン、色分け、相互連携）を完全に解決するための、詳細なフロントエンド修正計画書。

## 2.根本原因のまとめ

-   **ハイライト視認性の低さ:** 色定義が薄すぎた (`bg-*-100`)。
-   **アコーディオンデザインの不備:** コンテンツの余백不足と、唐突な枠線デザイン。
-   **色分けの未実装:** レビュワーごとの色分けロジックがコンポーネントに適用されていなかった。
-   **相互連携の不備:** 状態変更がUIコンポーネントにpropsとして伝播されておらず、視覚的なフィードバックが機能していなかった。

## 3. 修正対象ファイルと作業順序

以下の順序で修正を進めることで、依存関係を解決し、効率的に実装を進めることができる。

1.  `frontend/lib/utils.ts`
2.  `frontend/components/review/IssueAccordionItem.tsx`
3.  `frontend/components/review/IssueListView.tsx`
4.  `frontend/components/PrdTextView.tsx`

---

## 4. 詳細な修正方針

### **ステップ1: 色定義の抜本的見直し (`frontend/lib/utils.ts`)**

-   **やりたいこと:** UI全体で利用する「色」の定義を、一箇所にまとめて管理したい。
-   **現状の課題 (AsIs):** 色分けのロジックがどこにも存在せず、各コンポーネントが固定色（例: 黄色）を使ってしまっている。また、現状の色定義は薄すぎて背景に紛れてしまい、視認性が低い。
-   **あるべき姿 (ToBe):** `getAgentColorClasses(agentName)` を呼び出すだけで、誰が見ても明確に認識できる、コントラストの高い色のセットが一元的に取得できる状態。
-   **実装方針:**
    -   `getAgentColorClasses`関数が返すオブジェクトの各色定義を、**より濃く、視認性の高いものに全面的に変更**する。

| 対象     | 変更前 (薄い) | **変更後 (明確)** |
| :------- | :-------------- | :---------------- |
| 通常BG   | `bg-*-100`      | **`bg-*-200`**    |
| 選択時BG | `bg-*-200`      | **`bg-*-300`**    |
| リング色 | `ring-*-400`    | **`ring-*-500`**  |
| ボーダー色 | `border-*-400`  | **`border-*-500`**|

- **コード修正イメージ:**
  ```typescript
  // frontend/lib/utils.ts
  // ...
  if (name.includes("ux")) {
    return { bg: "bg-blue-200", bgActive: "bg-blue-300", ring: "ring-blue-500", border: "border-blue-500" };
  }
  // ... 他のエージェントも同様に修正
  ```

### **ステップ2: アコーディオンUIの洗練 (`frontend/components/review/IssueAccordionItem.tsx`)**

-   **やりたいこと:** 窮屈で分かりにくいアコーディオンのデザインを、洗練された直感的なものにしたい。
-   **現状の課題 (AsIs):** コンテンツ部分に余白がなく窮屈に見える。太い枠線が目立ちすぎて悪目立ちしている。自分が選択されているかどうかも分からない。
-   **あるべき姿 (ToBe):** 十分な余白があり、小さな色のドットでレビュワーを示し、背景色で選択状態が明確に分かる、モダンで分かりやすいUI。
-   **実装方針:**
    1.  **propsの追加:** 親から`isSelected: boolean`を受け取れるようにする。
    2.  **スタイリングの全面改修:**
        -   太い`border-l-4`を**削除**する。
        -   代わりに、ヘッダー内部に**色のドット**を追加する。
        -   `isSelected`の状態に応じて、ヘッダーの**背景色**を変える。
        -   コンテンツ部分に十分な`padding`を追加する。

### **ステップ3: 状態とPropsの連携による相互連携の確立 (`frontend/components/review/IssueListView.tsx`)**

-   **やりたいこと:** 左ペインの**ハイライト**をクリックした瞬間に、右ペインの対応する**アコーディオン**の見た目（背景色など）が確実に変わる、という**相互連携**を実現する。

-   **現状の課題 (AsIs):**
    -   ハイライトをクリックすると、グローバルな状態（`expandedIssueId`）は正しく更新される。
    -   しかし、`IssueAccordionItem`（アコーディオンの各項目）は、その状態変更を検知して自分自身を再描画するすべを持っていない。
    -   結果として、状態は変わっているのに、見た目が追従しない「**壊れた連携**」状態になっている。

-   **あるべき姿 (ToBe):**
    -   グローバルな状態（`expandedIssueId`）が、アプリケーションの唯一の信頼できる情報源（Single Source of Truth）となる。
    -   親コンポーネント（`IssueListView`）がその状態を監視し、「あなた（`IssueAccordionItem`）は今選択されていますよ」という情報を、**`isSelected`という単純な`true/false`のprops**として子に教える。
    -   子コンポーネントは、渡された`isSelected`の値に基づいて、ただ自身の見た目を変えることに専念する。

-   **実装方針:**
    -   `IssueListView.tsx`の`issues.map`の中で`IssueAccordionItem`を呼び出す際に、**`isSelected` propを明示的に渡す**。
        ```tsx
        <IssueAccordionItem ... isSelected={issue.issue_id === expandedIssueId} />
        ```
    -   この一行の追加が、状態とUIの連携を確実にするための、最も重要で本質的な修正となる。

### **ステップ4: ハイライトの色分けと選択状態の反映 (`frontend/components/PrdTextView.tsx`)**

-   **やりたいこと:** 左ペインのハイライトを、右ペインのアコーディオンと視覚的に連動させたい。
-   **現状の課題 (AsIs):** 全てのハイライトが同じ色で、どの指摘が誰のものか区別がつかない。また、選択状態になっても見た目の変化が乏しく、アコーディオンと連動している感覚がない。
-   **あるべき姿 (ToBe):** レビュワーごとの色でハイライトされ、選択されたものは濃い背景色とリングで強調表示されることで、アコーディオンとの視覚的な繋がりが完成している状態。
-   **実装方針:**
    1.  **データ構造の準備:** `mark`コンポーネント内で`agent_name`を参照できるよう、`issues`配列を`Map`に変換しておく。
    2.  **スタイリングロジックの修正:** `className`を動的に生成し、`isSelected`の状態に応じて**通常時の背景色**と、**選択時の背景色＋リング**を使い分ける。
