# å…±é€šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹é€ åŒ–æ¡ˆ

## æ¦‚è¦

`agents.toml`ã«å…±é€šãƒ‘ãƒ¼ãƒ„ã‚’å®šç¾©ã—ã€Pythonã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§å‹•çš„ã«çµåˆã™ã‚‹å®Ÿè£…æ¡ˆã§ã™ã€‚

## 1. æ–°ã—ã„ agents.toml æ§‹é€ 

```toml
# ------------------------------------------------
# å…±é€šãƒ‘ãƒ¼ãƒ„å®šç¾©
# ------------------------------------------------
[common]
# ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã®å…±é€šå‡ºåŠ›ä»•æ§˜
output_format_review = """
ã€å‡ºåŠ›ä»•æ§˜ï¼ˆå³å®ˆï¼‰ã€‘
- ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯è¨˜æ³•ï¼ˆ``` ã‚„ ```json ãªã©ï¼‰ã¯çµ¶å¯¾ã«ä½¿ç”¨ã—ãªã„ã€‚ç´”ç²‹ãª JSON ã‚’è¿”ã™ã“ã¨ã€‚
- ãƒ«ãƒ¼ãƒˆã‚­ãƒ¼: "issues"ï¼ˆé…åˆ—ï¼‰ã€‚
- è¦ç´ ã‚¹ã‚­ãƒ¼ãƒ: {"priority":1|2|3,"summary":"æŒ‡æ‘˜ã®20å­—è¦ç´„","comment":"â€¦","original_text":"â€¦","span":{"start_index":number,"end_index":number}}ï¼ˆspan ã¯ PRD å†…ã§ original_text ãŒæœ€åˆã«å‡ºç¾ã™ã‚‹ä½ç½®ã€‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯çœç•¥å¯ï¼‰
- priority ã¯ 1 / 2 / 3 ã®ã„ãšã‚Œã‹ï¼ˆä»–ã®å€¤ã¯ç¦æ­¢ï¼‰ã€‚
- summary ã¯æ—¥æœ¬èªã§20æ–‡å­—ç¨‹åº¦ã®çŸ­ã„ã‚¿ã‚¤ãƒˆãƒ«ã€‚
- comment ã¯æ—¥æœ¬èªã§1-3æ–‡ã€{å°‚é–€åˆ†é‡}ã®è¦³ç‚¹ã‹ã‚‰å…·ä½“çš„ã‹ã¤å®Ÿè¡Œå¯èƒ½ãªåŠ©è¨€ã‚’å«ã‚ã‚‹ï¼ˆæŠ½è±¡è«–ã‚„ä¸€èˆ¬è«–ã®ç¾…åˆ—ã¯é¿ã‘ã‚‹ï¼‰ã€‚
- original_text ã¯PRDã‹ã‚‰ã®æœ€å°é™ã®æŠœç²‹ï¼ˆæœ€å¤§200æ–‡å­—ã€æ”¹å¤‰ã›ãšåŸæ–‡ã‚’å¼•ç”¨ï¼‰ã€‚span ã¯ãã®æŠœç²‹ã® PRD å†…ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0å§‹ã¾ã‚Šã€åŠé–‹åŒºé–“ï¼‰ã€‚
- ä»¶æ•°ç›®å®‰: 3-7ä»¶ã€‚é‡è¤‡ã¯é¿ã‘ã€å½±éŸ¿åº¦ã®é«˜ã„ã‚‚ã®ã‚’å„ªå…ˆã€‚
"""

# ãƒãƒ£ãƒƒãƒˆæ™‚ã®å…±é€šå›ç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
output_format_chat = """
ã€å›ç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå³å®ˆï¼‰ã€‘
- å¸¸ã«Markdownå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
- é‡è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ **ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰** ã®ã‚ˆã†ã«å¼·èª¿ã—ã¦ãã ã•ã„ã€‚
- ç®‡æ¡æ›¸ããŒé©åˆ‡ãªå ´åˆã¯ `-` ã‚’ä½¿ã£ã¦ãƒªã‚¹ãƒˆå½¢å¼ã«ã—ã¦ãã ã•ã„ã€‚
- ä¸€å›ã®å¿œç­”ã¯200æ–‡å­—ç¨‹åº¦ã«åã‚ã¦ãã ã•ã„ã€‚å¯¾è©±ã‚’æ„è­˜ã—ãŸç°¡æ½”ãªå¿œç­”ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚
"""

# å„ªå…ˆåº¦åˆ¤å®šã®å…±é€šåŸºæº–
priority_guidelines = """
ã€å„ªå…ˆåº¦åˆ¤å®šåŸºæº–ã€‘
- priority=1: {critical_issues}
- priority=2: {moderate_issues}
- priority=3: {minor_issues}
"""

# ------------------------------------------------
# å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å›ºæœ‰éƒ¨åˆ†
# ------------------------------------------------
[engineer]
persona = "ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚"
review_focus = "PRDã‚’ä»¥ä¸‹ã®è¦³ç‚¹ï¼ˆã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£/ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹/ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£/DBè¨­è¨ˆ/APIè¨­è¨ˆï¼‰ã‹ã‚‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€æŠ€è¡“çš„ãƒªã‚¹ã‚¯ã€æ€§èƒ½ä¸Šã®æ‡¸å¿µã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ›ãƒ¼ãƒ«ã€æ›–æ˜§ãªå®Ÿè£…ç‚¹ã‚’æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚å¤§è¦æ¨¡ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚„ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã«ã‚‚ç•™æ„ã—ã¦ãã ã•ã„ã€‚"
specialist_field = "æŠ€è¡“çš„å®Ÿç¾æ€§ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ä¿å®ˆæ€§"
critical_issues = "é‡å¤§ãªä¸æ•´åˆ/æ¬ è½/ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»å¯ç”¨æ€§ãƒªã‚¹ã‚¯/æ€§èƒ½åŠ£åŒ–ãŒé«˜ç¢ºåº¦ã§ç™ºç”Ÿã™ã‚‹æ‡¸å¿µ"
moderate_issues = "æ˜ç¢ºãªæ‡¸å¿µã ãŒå›é¿ç­–ãŒæ¯”è¼ƒçš„å®¹æ˜“ã€ã¾ãŸã¯å½±éŸ¿ç¯„å›²ãŒé™å®šçš„"
minor_issues = "æœ›ã¾ã—ã„æ”¹å–„ï¼ˆè¡¨ç¾/å‘½å/è»½å¾®ãªæ›–æ˜§ã• ãªã©ï¼‰"

chat_persona = "ã‚ãªãŸã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®ç«‹å ´ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å°‚é–€çš„ã«å›ç­”ã—ã¾ã™ã€‚"
chat_focus = "å®Ÿè£…æ–¹é‡ã€è¨­è¨ˆä¸Šã®åˆ¤æ–­ã€æ€§èƒ½/ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£/ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è¦³ç‚¹ã‹ã‚‰ã€å…·ä½“çš„ã§å®Ÿè¡Œå¯èƒ½ãªåŠ©è¨€ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚"

[data_scientist]
persona = "ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ãƒ†ã‚£ã‚¹ãƒˆã§ã™ã€‚"
review_focus = "PRDã‚’ãƒ‡ãƒ¼ã‚¿åˆ†æ/åŠ¹æœæ¸¬å®š/KPIè¨ˆæ¸¬å¯èƒ½æ€§/A/Bãƒ†ã‚¹ãƒˆè¨­è¨ˆ/ãƒ­ã‚°è¨­è¨ˆã®è¦³ç‚¹ã‹ã‚‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³ãªæ„æ€æ±ºå®šã«å¿…è¦ãªè¦ç´ ã®ä¸è¶³ã‚„è¨ˆæ¸¬å›°é›£ãªæŒ‡æ¨™ã‚’æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚çµ±è¨ˆçš„æœ‰æ„æ€§ã‚„ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºã®å¦¥å½“æ€§ã«ã‚‚ç•™æ„ã—ã¦ãã ã•ã„ã€‚"
specialist_field = "ãƒ‡ãƒ¼ã‚¿åé›†ãƒ»åˆ†ææ‰‹æ³•ãƒ»çµ±è¨ˆçš„æ¤œè¨¼"
critical_issues = "KPIæœªå®šç¾©/è¨ˆæ¸¬ä¸å¯èƒ½/çµ±è¨ˆçš„å¦¥å½“æ€§ã®é‡å¤§ãªå•é¡Œ/ãƒ‡ãƒ¼ã‚¿åé›†åŸºç›¤ã®è‡´å‘½çš„æ¬ è½"
moderate_issues = "æŒ‡æ¨™ã®æ›–æ˜§ã•/åˆ†ææ‰‹æ³•ã®ä¸æ˜ç¢ºã•/A/Bãƒ†ã‚¹ãƒˆè¨­è¨ˆã®èª²é¡Œ"
minor_issues = "ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–ãƒ»ãƒ¬ãƒãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®æ”¹å–„ææ¡ˆ"

chat_persona = "ã‚ãªãŸã¯ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ãƒ†ã‚£ã‚¹ãƒˆã®ç«‹å ´ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å°‚é–€çš„ã«å›ç­”ã—ã¾ã™ã€‚"
chat_focus = "ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ»çµ±è¨ˆçš„æ¤œè¨¼ãƒ»KPIè¨­è¨ˆãƒ»A/Bãƒ†ã‚¹ãƒˆãƒ»æ©Ÿæ¢°å­¦ç¿’ã®è¦³ç‚¹ã‹ã‚‰ã€å…·ä½“çš„ã§å®Ÿè¡Œå¯èƒ½ãªåŠ©è¨€ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚"

# ... ä»–ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚‚åŒæ§˜
```

## 2. Pythonå®Ÿè£…ã®å¤‰æ›´

### specialist.py ã®æ‹¡å¼µ

```python
def build_instruction_from_template(role_cfg: dict[str, str], common_cfg: dict[str, str], instruction_type: str) -> str:
    """å…±é€šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå›ºæœ‰è¨­å®šã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰"""

    if instruction_type == "review":
        # ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰
        persona = role_cfg.get("persona", "")
        review_focus = role_cfg.get("review_focus", "")
        specialist_field = role_cfg.get("specialist_field", "å°‚é–€çš„è¦³ç‚¹")

        # å…±é€šå‡ºåŠ›ä»•æ§˜ã‚’å–å¾—ã—ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’ç½®æ›
        output_format = common_cfg.get("output_format_review", "").replace(
            "{å°‚é–€åˆ†é‡}", specialist_field
        )

        # å„ªå…ˆåº¦ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰
        priority_template = common_cfg.get("priority_guidelines", "")
        priority_guidelines = priority_template.format(
            critical_issues=role_cfg.get("critical_issues", ""),
            moderate_issues=role_cfg.get("moderate_issues", ""),
            minor_issues=role_cfg.get("minor_issues", "")
        )

        # æœ€çµ‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆçµ„ã¿ç«‹ã¦
        return f"{persona}\n{review_focus}\n\n{output_format}\n\n{priority_guidelines}"

    elif instruction_type == "chat":
        # ãƒãƒ£ãƒƒãƒˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰
        chat_persona = role_cfg.get("chat_persona", "")
        chat_focus = role_cfg.get("chat_focus", "")
        output_format = common_cfg.get("output_format_chat", "")

        return f"{chat_persona}\n{chat_focus}\n\n{output_format}"

    return ""


def load_agent_prompts() -> dict[str, dict[str, str]]:
    """Load and process agent prompts with common template expansion."""
    prompts_path = Path(__file__).parent.parent.parent.parent / "prompts" / "agents.toml"

    try:
        with prompts_path.open("rb") as f:
            config = tomllib.load(f)

        common_cfg = config.get("common", {})
        processed_prompts = {}

        for agent_name, agent_cfg in config.items():
            if agent_name == "common":
                continue

            processed_prompts[agent_name] = {
                "instruction_review": build_instruction_from_template(
                    agent_cfg, common_cfg, "review"
                ),
                "instruction_chat": build_instruction_from_template(
                    agent_cfg, common_cfg, "chat"
                )
            }

        return processed_prompts

    except FileNotFoundError:
        logger.error(f"Prompts file not found: {prompts_path}")
        return {}
    except tomllib.TOMLDecodeError as e:
        logger.error(f"Failed to parse TOML file: {e}")
        return {}
```

## 3. å®Ÿè£…ã®ãƒ¡ãƒªãƒƒãƒˆ

### ğŸ¯ ä¿å®ˆæ€§å‘ä¸Š
- å…±é€šéƒ¨åˆ†ï¼ˆå‡ºåŠ›ä»•æ§˜ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰ã‚’1ç®‡æ‰€ã§ç®¡ç†
- æ–°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¿½åŠ æ™‚ã®é‡è¤‡ã‚³ãƒ¼ãƒ‰å‰Šæ¸›
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¤‰æ›´æ™‚ã®å½±éŸ¿ç¯„å›²ã‚’æœ€å°åŒ–

### ğŸ”§ æŸ”è»Ÿæ€§
- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå›ºæœ‰éƒ¨åˆ†ã¨å…±é€šéƒ¨åˆ†ã®æ˜ç¢ºãªåˆ†é›¢
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã«ã‚ˆã‚‹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
- æ®µéšçš„ç§»è¡ŒãŒå¯èƒ½ï¼ˆæ—¢å­˜ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚‚ä¸¦è¡Œç¨¼åƒï¼‰

### ğŸ“ˆ ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£
- 9äººâ†’ã•ã‚‰ã«å¤šãã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸ã®æ‹¡å¼µãŒå®¹æ˜“
- æ–°ã—ã„å…±é€šãƒ‘ãƒ¼ãƒ„ï¼ˆä¾‹ï¼šå¤šè¨€èªå¯¾å¿œï¼‰ã®è¿½åŠ ãŒç°¡å˜

## 4. å®Ÿè£…é›£æ˜“åº¦ã¨å·¥æ•°

### ğŸŸ¢ **ä½ãƒªã‚¹ã‚¯ãƒ»ä¸­ç¨‹åº¦å·¥æ•°**

**å¿…è¦ãªå¤‰æ›´:**
1. `specialist.py`ã®`load_agent_prompts()`æ‹¡å¼µ - **2-3æ™‚é–“**
2. `agents.toml`æ§‹é€ å¤‰æ›´ - **1-2æ™‚é–“**
3. æ—¢å­˜ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆç¢ºèª - **1æ™‚é–“**
4. æ–°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ5äººåˆ†ã®è¨­å®š - **1-2æ™‚é–“**

**ç·å·¥æ•°: 5-8æ™‚é–“ç¨‹åº¦**

## 5. ç§»è¡Œæˆ¦ç•¥

### Phase 1: å…±é€šåŒ–åŸºç›¤æ§‹ç¯‰
1. æ–°ã—ã„`build_instruction_from_template()`é–¢æ•°å®Ÿè£…
2. å¾Œæ–¹äº’æ›æ€§ç¢ºä¿ï¼ˆæ—¢å­˜ã®`instruction_review`/`instruction_chat`ã‚‚ã‚µãƒãƒ¼ãƒˆï¼‰

### Phase 2: æ®µéšçš„ç§»è¡Œ
1. 1ã¤ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆengineerãªã©ï¼‰ã‚’æ–°å½¢å¼ã«ç§»è¡Œ
2. ãƒ†ã‚¹ãƒˆç¢ºèªå¾Œã€ä»–ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚‚é †æ¬¡ç§»è¡Œ

### Phase 3: æ–°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¿½åŠ 
1. æ–°5ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’æ–°å½¢å¼ã§å®Ÿè£…
2. å…¨ä½“ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼

**æ¨å¥¨**: ã“ã®å…±é€šåŒ–ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§å®Ÿè£…ã‚’é€²ã‚ã‚‹ã“ã¨ã§ã€é•·æœŸçš„ãªä¿å®ˆæ€§ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã™ã€‚
