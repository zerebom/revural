options:
  logging: CLOUD_LOGGING_ONLY
  machineType: E2_HIGHCPU_8
substitutions:
  _REGION: asia-northeast1
  _BACKEND_SERVICE: hibikasu-backend
  _FRONTEND_SERVICE: hibikasu-frontend
  _BACKEND_IMAGE: hibikasu-backend
  _FRONTEND_IMAGE: hibikasu-frontend
  _FRONTEND_API_URL: https://hibikasu-backend-placeholder.a.run.app
  _BACKEND_ALLOWED_ORIGINS: https://hibikasu-frontend-placeholder.a.run.app
steps:
  - name: gcr.io/cloud-builders/docker
    id: build-backend
    args:
      - build
      - -f
      - backend.Dockerfile
      - -t
      - gcr.io/$PROJECT_ID/${_BACKEND_IMAGE}:$COMMIT_SHA
      - .
  - name: gcr.io/cloud-builders/docker
    id: build-frontend
    args:
      - build
      - -f
      - frontend.Dockerfile
      - --build-arg
      - NEXT_PUBLIC_API_BASE_URL=${_FRONTEND_API_URL}
      - -t
      - gcr.io/$PROJECT_ID/${_FRONTEND_IMAGE}:$COMMIT_SHA
      - .
  - name: gcr.io/cloud-builders/docker
    id: push-backend
    args:
      - push
      - gcr.io/$PROJECT_ID/${_BACKEND_IMAGE}:$COMMIT_SHA
  - name: gcr.io/cloud-builders/docker
    id: push-frontend
    args:
      - push
      - gcr.io/$PROJECT_ID/${_FRONTEND_IMAGE}:$COMMIT_SHA
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: deploy-backend
    entrypoint: gcloud
    args:
      - run
      - deploy
      - ${_BACKEND_SERVICE}
      - --image=gcr.io/$PROJECT_ID/${_BACKEND_IMAGE}:$COMMIT_SHA
      - --region=${_REGION}
      - --platform=managed
      - --allow-unauthenticated
      - --min-instances=0
      - --max-instances=3
      - --timeout=300
      - --cpu=1
      - --memory=1Gi
      - --set-env-vars
      - HIBIKASU_API_MODE=ai,ADK_MODEL=gemini-2.5-flash-lite,HIBIKASU_LOG_LEVEL=INFO,LOG_LEVEL=INFO,CORS_ALLOW_ORIGINS=${_BACKEND_ALLOWED_ORIGINS}
      - --set-secrets
      - GOOGLE_API_KEY=gemini-api-key:latest
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: deploy-frontend
    entrypoint: gcloud
    args:
      - run
      - deploy
      - ${_FRONTEND_SERVICE}
      - --image=gcr.io/$PROJECT_ID/${_FRONTEND_IMAGE}:$COMMIT_SHA
      - --region=${_REGION}
      - --platform=managed
      - --allow-unauthenticated
      - --min-instances=0
      - --max-instances=3
      - --timeout=300
      - --cpu=1
      - --memory=512Mi
      - --set-env-vars
      - NEXT_PUBLIC_API_BASE_URL=${_FRONTEND_API_URL}
      - --set-env-vars
      - NODE_ENV=production
images:
  - gcr.io/$PROJECT_ID/${_BACKEND_IMAGE}:$COMMIT_SHA
  - gcr.io/$PROJECT_ID/${_FRONTEND_IMAGE}:$COMMIT_SHA
